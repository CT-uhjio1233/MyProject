<!DOCTYPE html>
<html lang="zh-tw">
<head>
    <title>Echarts</title>
    <meta charset="utf-8">
    <title>ECharts</title>
    <script src="echarts.min.js"></script>
    <script src="jquery.min.js"></script>
    <style>
        *{
            margin: 0px;
            font-size: 20px;
        }
        #set{
            width: 1490px;
            height: 1055px;
        }
        #header{
            color: white;
            font-size: 42px;
            background-color: rgb(38, 124, 38);
            width: 100%;
            height: 125px;
        }
        #wrap{
            float: left;
            width: 100%;
        }  
        #main{
            margin-left:10%;
            width: 80%;
            height: 850px;
        }
        #device{
            margin-left: 35px;
            text-align: center;
            font-size: 30px;
            width: 300px;
            height: 40px;
            color: white;
            background-color: rgb(38, 124, 38);
        }
        #dev_pm2{
            margin: 25px 0 0 35px;
            float: left;
            width: 550px;
            height: 350px;
            border: 5px green solid;
        }
        #dev_pm10{
            margin: 25px 0 0 30px;
            float: left;
            width: 550px;
            height: 350px;
            border: 5px green solid;
        }
        #dev_temp{
            margin:25px 0 0 35px;
            clear: both;
            float: left;
            width: 550px;
            height: 350px;
            border: 5px green solid;
        }
        #dev_hum{
            margin:25px 0 0 30px;
            float: left;
            width: 550px;
            height: 350px;
            border: 5px green solid;
        }
    </style>
</head>

<body>
   <div id="set">
       <div id="header">
           <img src="img/title.png">
       </div>
       <div id="wrap">
           <div id="main">
           <p id="device"></p>
           <div id="dev_pm2"></div>
           <div id="dev_pm10"></div>
           <div id="dev_temp"></div>
           <div id="dev_hum"></div>
           </div>
       </div> 
   </div>

    <script type="text/javascript">


    window.onload=device1;

    var dev_pm2=echarts.init(document.getElementById('dev_pm2'));
    var dev_pm10=echarts.init(document.getElementById('dev_pm10'));
    var dev_temp=echarts.init(document.getElementById('dev_temp'));
    var dev_hum=echarts.init(document.getElementById('dev_hum'));
    dev_pm2.showLoading();dev_pm10.showLoading();dev_temp.showLoading();dev_hum.showLoading();

    var data1=get_data("AIU2U4E7PGCJQ4S8","AIU2U4E7PGCJQ4S8","AIU2U4E7PGCJQ4S8","AIU2U4E7PGCJQ4S8","AIU2U4E7PGCJQ4S8",1);
    var data2=get_data("AIU2U4E7PGCJQ4S8","AIU2U4E7PGCJQ4S8","AIU2U4E7PGCJQ4S8","AIU2U4E7PGCJQ4S8","AIU2U4E7PGCJQ4S8",2);
    var data3=get_data("AIU2U4E7PGCJQ4S8","AIU2U4E7PGCJQ4S8","AIU2U4E7PGCJQ4S8","AIU2U4E7PGCJQ4S8","AIU2U4E7PGCJQ4S8",3);
    var data4=get_data("AIU2U4E7PGCJQ4S8","AIU2U4E7PGCJQ4S8","AIU2U4E7PGCJQ4S8","AIU2U4E7PGCJQ4S8","AIU2U4E7PGCJQ4S8",4);

    var time_dev=get_time("AIU2U4E7PGCJQ4S8");


    function device1(){
        dev_pm2.hideLoading();dev_pm10.hideLoading();dev_temp.hideLoading();dev_hum.hideLoading();

        dev_pm2.setOption({ 
        title: {
        text: 'PM2.5'
        },
        tooltip: {},
        legend: {
            data:['ug/m3']
        },
        xAxis: {
            data: [time_dev[0],time_dev[1],time_dev[2],time_dev[3],time_dev[4]]
        },
        yAxis: {},
        series: [{
            name: 'ug/m3',
            type: 'line',
            data: [data1[0],data1[1],data1[2],data1[3],data1[4]]
        }]
        });

        dev_pm10.setOption({ 
        title: {
        text: 'PM10'
        },
        tooltip: {},
        legend: {
            data:['ug/m3']
        },
        xAxis: {
            data: [time_dev[0],time_dev[1],time_dev[2],time_dev[3],time_dev[4]]
        },
        yAxis: {},
        series: [{
            name: 'ug/m3',
            type: 'line',
            data: [data2[0],data2[1],data2[2],data2[3],data2[4]]
        }]
        });

        dev_temp.setOption({ 
        title: {
        text: 'Temperature'
        },
        tooltip: {},
        legend: {
            data:['°C']
        },
        xAxis: {
            data: [time_dev[0],time_dev[1],time_dev[2],time_dev[3],time_dev[4]]
        },
        yAxis: {},
        series: [{
            name: '°C',
            type: 'line',
            data: [data3[0],data3[1],data3[2],data3[3],data3[4]]
        }]
        });

        dev_hum.setOption({ 
        title: {
        text: 'Humidity'
        },
        tooltip: {},
        legend: {
            data:['%RH']
        },
        xAxis: {
            data: [time_dev[0],time_dev[1],time_dev[2],time_dev[3],time_dev[4]]
        },
        yAxis: {},
        series: [{
            name: '%RH',
            type: 'line',
            data: [data4[0],data4[1],data4[2],data4[3],data4[4]]
        }]
        });
        document.getElementById("device").innerHTML="Device1";
        warninglevel(data[4]);
        updata("https://api.thingspeak.com/channels/1008690/feeds.json?key=AIU2U4E7PGCJQ4S8","Device1");
}

function get_time(key){
    time_dev=[];
    $.get("https://api.thingspeak.com/channels/1008690/feeds.json?key="+key).done(function(data){
        for(var i=95;i<=99;i++){
            time_dev.push((data.feeds[i].created_at).substring(11,19));
        }
    });
    return time_dev;
}
function get_data(key1,key2,key3,key4,key5,number){
    data1=[];
    data2=[];
    data3=[];
    data4=[];
    data5=[];
    data=[];
    for(var i=1;i<=5;i++){
        $.get("https://api.thingspeak.com/channels/1008690/feeds.json?key="+key+i).done(function(data){
        for(var i=95;i<=99;i++){
            data.push(data.feeds[i].field+number);
        }
    });
    for(var i=0;i<4;i++){
    data[i]=(data1[i]+data2[i]+data3[i]+data4[i]+data5[i])/5;    
    
    }
    return data;
}
   function updata(com ,devnum){

        setInterval(function(){

        $.get(com).done(function(data){

            function addData(shift){
            date.push(data.feeds[99].created_at.substring(0,10)+"-"+data.feeds[99].created_at.substring(11,19));
            time_dev5.push((data.feeds[99].created_at).substring(11,19));
           
            feed_dev_1.push(data.feeds[99].field1);
            feed_dev_2.push(data.feeds[99].field2);
            feed_dev_3.push(data.feeds[99].field3);
            feed_dev_4.push(data.feeds[99].field4);
            if(date.length>10){
                date.shift();
            }
            if(shift){
                time_dev.shift();
                for(var i=1;i<=4;i++){
                    feed_dev_+i.shift();
                } 
            }
            }

        if(time_dev[4]!=((data.feeds[99].created_at).substring(11,19))){
                addData(true);
        }

        dev_pm2.setOption({
        xAxis: {
            data: [time_dev[0],time_dev[1],time_dev[2],time_dev[3],time_dev[4]]
        },
        series: [{
            data: [feed_dev_1[0],feed_dev_1[1],feed_dev_1[2],feed_dev_1[3],feed_dev_1[4]]
        }]
        });

        dev_pm10.setOption({
        xAxis: {
            data: [time_dev[0],time_dev[1],time_dev[2],time_dev[3],time_dev[4]]
        },
        series: [{
            data: [feed_dev_2[0],feed_dev_2[1],feed_dev_2[2],feed_dev_2[3],feed_dev_2[4]]
        }]
        });

        dev_temp.setOption({
        xAxis: {
            data: [time_dev[0],time_dev[1],time_dev[2],time_dev[3],time_dev[4]]
        },
        series: [{
            data: [feed_dev_3[0],feed_dev_3[1],feed_dev_3[2],feed_dev_3[3],feed_dev_3[4]]
        }]
        });

        dev_hum.setOption({
        xAxis: {
            data: [time_dev[0],time_dev[1],time_dev[2],time_dev[3],time_dev[4]]
        },
        series: [{
            data: [feed_dev_4[0],feed_dev_4[1],feed_dev_4[2],feed_dev_4[3],feed_dev_4[4]]
        }]
        });
        document.getElementById("device").innerHTML=devnum;
        document.getElementById("lastupdata").innerHTML=date+"-"+devnum;
        warninglevel(feed_dev1_1[4]);
        }); 
        },1000);
   }
}
    </script>
</body>
</html>